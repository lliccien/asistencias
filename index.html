<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario ENTRADA/SALIDA</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3b82f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Asistencia" />
  <meta name="description" content="Formulario web para registrar entradas y salidas de personal" />
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <link rel="manifest" href="manifest.json" />
  <style>
    /* Diseño mobile-first, centrado vertical y horizontal */
    :root {
      --bg: #0f172a;      /* slate-900 */
      --card: #111827;    /* gray-900 */
      --txt: #e5e7eb;     /* gray-200 */
      --muted: #9ca3af;   /* gray-400 */
      --accent: #3b82f6;  /* blue-500 */
      --error: #ef4444;   /* red-500 */
      --ok: #10b981;      /* emerald-500 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 16px; color: var(--txt);
      background: linear-gradient(135deg, #0b1022, var(--bg));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      min-height: 100svh; /* mejor en móviles con barras dinámicas */
      display: flex; flex-direction: column; align-items: center; justify-content: center; /* centra V+H */
    }

    .cards-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 420px;
    }

    .card {
      width: 100%; background: var(--card);
      border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    h1 { font-size: 1.1rem; margin: 0 0 10px; }
    .sub { margin: 0 0 16px; font-size: .9rem; color: var(--muted); }
    .field { margin-bottom: 14px; }
    label { display: block; margin-bottom: 6px; font-size: .9rem; }

    select, input[type="date"], input[type="time"], button {
      width: 100%; padding: 12px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: #0b1220; color: var(--txt); font-size: 1rem; outline: none;
    }

    select:focus, input:focus, button:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59,130,246,.25);
    }

    small.hint { display: block; color: var(--muted); margin-top: 6px; }
    small.error { display: none; color: var(--error); margin-top: 6px; }
    .field.invalid small.error { display: block; }
    .field.invalid select,
    .field.invalid input { border-color: var(--error); }

    button { margin-top: 6px; background: var(--accent); border: 1px solid transparent; cursor: pointer; font-weight: 600; }
    button:hover { filter: brightness(1.05); }

    .loading { opacity: .7; pointer-events: none; }

    /* Snackbar */
    .snackbar {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%) translateY(120%);
      min-width: 240px;
      max-width: min(92vw, 560px);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.08);
      opacity: 0;
      transition: transform .28s ease, opacity .28s ease;
      z-index: 1000;
    }
    .snackbar.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .snackbar.ok  { background: rgba(16,185,129,.12); color: #bbf7d0; border-color: rgba(16,185,129,.35); }
    .snackbar.err { background: rgba(239,68,68,.12); color: #fecaca; border-color: rgba(239,68,68,.35); }

    /* PWA Install Prompt */
    .install-prompt {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      z-index: 1001;
      max-width: 320px;
      width: calc(100vw - 32px);
    }
    .install-content p {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: var(--txt);
    }
    .install-btn, .dismiss-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }
    .install-btn {
      background: var(--accent);
      color: white;
    }
    .dismiss-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,.12);
    }
    .install-btn:hover { filter: brightness(1.05); }
    .dismiss-btn:hover { background: rgba(255,255,255,.05); }

    /* Card de Descarga */
    .download-card {
      /* El espaciado ahora se maneja con gap en el contenedor */
    }
    .download-card h2 {
      font-size: 1.1rem;
      margin: 0 0 8px;
      color: var(--txt);
    }
    .download-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .download-btn {
      background: linear-gradient(135deg, var(--ok), #059669);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(16,185,129,.3);
    }
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16,185,129,.4);
    }
    .download-btn:active {
      transform: translateY(0);
    }
    .download-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .download-icon {
      font-size: 1.2rem;
    }
    .download-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .download-info small {
      color: var(--muted);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="cards-container">
    <form class="card" id="movForm" novalidate>
      <h1>Registrar movimiento</h1>
      <p class="sub">Se enviará un JSON por POST al webhook de n8n.</p>

      <!-- Tipo -->
      <div class="field" id="f-tipo">
        <label for="tipo">Tipo</label>
        <select name="tipo" id="tipo" required>
          <option value="">Selecciona…</option>
          <option value="ENTRADA">ENTRADA</option>
          <option value="SALIDA">SALIDA</option>
        </select>
        <small class="error">Selecciona ENTRADA o SALIDA.</small>
      </div>

      <!-- Fecha con selector nativo (yyyy-mm-dd) -->
      <div class="field" id="f-fecha">
        <label for="fecha">Fecha</label>
        <input id="fecha" name="fecha" type="date" required />
        <small class="hint">Usa el calendario para elegir la fecha.</small>
        <small class="error">Selecciona una fecha válida.</small>
      </div>

      <!-- Hora con selector nativo (HH:MM 24h) -->
      <div class="field" id="f-hora">
        <label for="hora">Hora</label>
        <input id="hora" name="hora" type="time" required step="60" />
        <small class="hint">Formato 24h: HH:MM.</small>
        <small class="error">Selecciona una hora válida.</small>
      </div>

      <button type="submit" id="btnSubmit">Enviar</button>
    </form>

    <!-- Card de Descarga -->
    <div class="card download-card">
      <h2>📊 Descargar Reporte</h2>
      <p class="sub">Descarga el archivo Excel con todos los registros de asistencia.</p>
      
      <div class="download-options">
        <button type="button" id="downloadBtn" class="download-btn">
          <span class="download-icon">📥</span>
          Descargar Excel
        </button>
        
        <div class="download-info">
          <small>📋 Formato: Excel (.xlsx)</small>
          <small>🔄 Se actualiza automáticamente</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>

  <!-- PWA Install Prompt -->
  <div id="installPrompt" class="install-prompt" style="display: none;">
    <div class="install-content">
      <p>📱 Instalar como aplicación</p>
      <button id="installBtn" class="install-btn">Instalar</button>
      <button id="dismissBtn" class="dismiss-btn">Más tarde</button>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = "https://n8n.ludwringliccien.dev/webhook/asistencias";

    // Helpers UI y validación
    const form = document.getElementById('movForm');
    const btn = document.getElementById('btnSubmit');
    const snackbar = document.getElementById('snackbar');
    const fieldWrap = (id) => document.getElementById(id);

    function setValidity(fieldId, valid) {
      const wrap = fieldWrap(fieldId);
      if (!wrap) return;
      wrap.classList.toggle('invalid', !valid);
    }
    function showSnack(type, msg, ms = 3500) {
      snackbar.textContent = msg;
      snackbar.className = `snackbar ${type}`;
      requestAnimationFrame(() => snackbar.classList.add('show'));
      clearTimeout(showSnack._t);
      showSnack._t = setTimeout(() => snackbar.classList.remove('show'), ms);
    }

    // Conversión: de ISO (yyyy-mm-dd) a dd/mm/aaaa
    function isoToDDMMYYYY(iso) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }

    // Validación básica de hora HH:MM
    function isValidHHMM(hhmm) {
      return /^\d{2}:\d{2}$/.test(hhmm);
    }

    // --- Pruebas rápidas en consola ("test cases") ---
    try {
      console.assert(isoToDDMMYYYY('2025-08-31') === '31/08/2025', 'isoToDDMMYYYY debe convertir correctamente');
      console.assert(isValidHHMM('09:05') === true, 'isValidHHMM debe aceptar 09:05');
      console.assert(isValidHHMM('23:59') === true, 'isValidHHMM debe aceptar 23:59');
      console.assert(isValidHHMM('9:5') === false, 'isValidHHMM debe rechazar 9:5');
    } catch (_) { /* ignorar en producción */ }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const tipoOk = form.tipo.value === 'ENTRADA' || form.tipo.value === 'SALIDA';
      setValidity('f-tipo', tipoOk);

      const fechaISO = form.fecha.value; // yyyy-mm-dd
      const fechaOk = /^\d{4}-\d{2}-\d{2}$/.test(fechaISO);
      setValidity('f-fecha', fechaOk);

      const horaVal = form.hora.value; // HH:MM
      const horaOk = isValidHHMM(horaVal);
      setValidity('f-hora', horaOk);

      if (!tipoOk || !fechaOk || !horaOk) {
        // Validación local: no llamar al webhook
        return;
      }

      // Payload JSON: envía la fecha en dd/mm/aaaa + ISO opcional
      const payload = {
        tipo: form.tipo.value,
        fecha: isoToDDMMYYYY(fechaISO), // requerido en dd/mm/aaaa
        fecha_iso: fechaISO,             // opcional para tu backend
        hora: horaVal                    // HH:MM (24h)
      };

      // UI: loading
      form.classList.add('loading');
      btn.disabled = true;

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*'
          },
          body: JSON.stringify(payload)
        });

        let responseText = '';
        const contentType = res.headers.get('content-type') || '';
        
        try {
          if (contentType.includes('application/json')) {
            const data = await res.json();
            responseText = JSON.stringify(data);
          } else {
            responseText = await res.text();
          }
        } catch (parseError) {
          // Si falla el parsing JSON, intentar como texto
          console.warn('Error parsing response as JSON, trying as text:', parseError);
          try {
            responseText = await res.text();
          } catch (textError) {
            console.warn('Error reading response as text:', textError);
            responseText = '';
          }
        }

        if (!res.ok) {
          showSnack('err', 'ERROR INTENTELO DE NUEVO');
        } else {
          showSnack('ok', `${form.tipo.value} guardada`);
          form.reset();
        }
      } catch (err) {
        console.error('Error de red o CORS:', err);
        showSnack('err', 'ERROR INTENTELO DE NUEVO');
      } finally {
        form.classList.remove('loading');
        btn.disabled = false;
      }
    });

    // ===== PWA FUNCTIONALITY =====
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js');
          console.log('Service Worker registrado:', registration);
          
          // Manejar actualizaciones del Service Worker
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showSnack('ok', 'Nueva versión disponible. Recarga para actualizar.');
              }
            });
          });
        } catch (error) {
          console.error('Error registrando Service Worker:', error);
        }
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const dismissBtn = document.getElementById('dismissBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Mostrar prompt después de 3 segundos
      setTimeout(() => {
        if (deferredPrompt && !localStorage.getItem('installPromptDismissed')) {
          installPrompt.style.display = 'block';
        }
      }, 3000);
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('Usuario eligió:', outcome);
        deferredPrompt = null;
        installPrompt.style.display = 'none';
      }
    });

    dismissBtn.addEventListener('click', () => {
      installPrompt.style.display = 'none';
      localStorage.setItem('installPromptDismissed', 'true');
    });

    // Detectar si la app está instalada
    window.addEventListener('appinstalled', () => {
      console.log('PWA instalada');
      installPrompt.style.display = 'none';
      showSnack('ok', '¡Aplicación instalada exitosamente!');
    });

    // Detectar estado de conexión
    function updateOnlineStatus() {
      if (navigator.onLine) {
        document.body.classList.remove('offline');
        showSnack('ok', 'Conexión restaurada');
      } else {
        document.body.classList.add('offline');
        showSnack('err', 'Sin conexión - Modo offline activado');
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // Verificar estado inicial
    updateOnlineStatus();

    // Background Sync (si está disponible)
    if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
      navigator.serviceWorker.ready.then(registration => {
        // Registrar para sincronización en segundo plano
        registration.sync.register('background-sync');
      });
    }

    // Notificaciones push (opcional)
    if ('Notification' in window && 'serviceWorker' in navigator) {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Permisos de notificación concedidos');
        }
      });
    }

    // ===== FUNCIONALIDAD DE DESCARGA =====
    
    const downloadBtn = document.getElementById('downloadBtn');
    const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/ID_DEL_DOCUMENTO/export?format=xlsx";
    
    downloadBtn.addEventListener('click', async () => {
      // Estado de carga
      downloadBtn.classList.add('loading');
      downloadBtn.innerHTML = '<span class="download-icon">⏳</span>Descargando...';
      
      try {
        // Crear un enlace temporal para la descarga
        const link = document.createElement('a');
        link.href = GOOGLE_SHEETS_URL;
        link.download = `asistencia_${new Date().toISOString().split('T')[0]}.xlsx`;
        link.target = '_blank';
        
        // Agregar el enlace al DOM temporalmente
        document.body.appendChild(link);
        
        // Simular clic para iniciar la descarga
        link.click();
        
        // Remover el enlace temporal
        document.body.removeChild(link);
        
        // Mostrar mensaje de éxito
        showSnack('ok', 'Descarga iniciada');
        
        // Log para debugging
        console.log('Descarga iniciada:', GOOGLE_SHEETS_URL);
        
      } catch (error) {
        console.error('Error al descargar:', error);
        showSnack('err', 'Error al descargar el archivo');
      } finally {
        // Restaurar estado del botón
        downloadBtn.classList.remove('loading');
        downloadBtn.innerHTML = '<span class="download-icon">📥</span>Descargar Excel';
      }
    });

    // Función alternativa para descarga directa (si la anterior no funciona)
    async function downloadFile() {
      try {
        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `asistencia_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showSnack('ok', 'Archivo descargado exitosamente');
      } catch (error) {
        console.error('Error en descarga alternativa:', error);
        showSnack('err', 'Error al descargar. Verifica la URL del documento.');
      }
    }
  </script>
</body>
</html>
