<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario ENTRADA/SALIDA</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3b82f6" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Asistencia" />
  <meta name="description" content="Formulario web para registrar entradas y salidas de personal" />
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <link rel="manifest" href="manifest.json" />
  <script src="config.js"></script>
  <style>
    /* Dise√±o mobile-first, centrado vertical y horizontal */
    :root {
      --bg: #0f172a;      /* slate-900 */
      --card: #111827;    /* gray-900 */
      --txt: #e5e7eb;     /* gray-200 */
      --muted: #9ca3af;   /* gray-400 */
      --accent: #3b82f6;  /* blue-500 */
      --error: #ef4444;   /* red-500 */
      --ok: #10b981;      /* emerald-500 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 16px; color: var(--txt);
      background: linear-gradient(135deg, #0b1022, var(--bg));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      min-height: 100svh; /* mejor en m√≥viles con barras din√°micas */
      display: flex; flex-direction: column; align-items: center; justify-content: center; /* centra V+H */
    }

    .cards-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 420px;
    }

    .card {
      width: 100%; background: var(--card);
      border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    h1 { font-size: 1.1rem; margin: 0 0 10px; }
    .sub { margin: 0 0 16px; font-size: .9rem; color: var(--muted); }
    .field { margin-bottom: 14px; }
    label { display: block; margin-bottom: 6px; font-size: .9rem; }

    select, input[type="date"], input[type="time"], button {
      width: 100%; padding: 12px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: #0b1220; color: var(--txt); font-size: 1rem; outline: none;
    }

    select:focus, input:focus, button:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59,130,246,.25);
    }

    small.hint { display: block; color: var(--muted); margin-top: 6px; }
    small.error { display: none; color: var(--error); margin-top: 6px; }
    .field.invalid small.error { display: block; }
    .field.invalid select,
    .field.invalid input { border-color: var(--error); }

    button { margin-top: 6px; background: var(--accent); border: 1px solid transparent; cursor: pointer; font-weight: 600; }
    button:hover { filter: brightness(1.05); }

    .loading { opacity: .7; pointer-events: none; }

    /* Estilos para autocompletado */
    .input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .input-group input {
      flex: 1;
    }
    
    .btn-now {
      width: auto;
      min-width: 44px;
      height: 44px;
      padding: 0;
      margin: 0;
      border-radius: 10px;
      background: rgba(59,130,246,.15);
      border: 1px solid rgba(59,130,246,.3);
      color: var(--accent);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .btn-now:hover {
      background: rgba(59,130,246,.25);
      border-color: var(--accent);
      transform: scale(1.05);
    }
    
    .btn-now:active {
      transform: scale(0.95);
    }
    
    .btn-autocomplete {
      width: 100%;
      background: linear-gradient(135deg, var(--ok), #059669);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(16,185,129,.3);
    }
    
    .btn-autocomplete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16,185,129,.4);
    }
    
    .btn-autocomplete:active {
      transform: translateY(0);
    }
    
    .btn-autocomplete.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .btn-link {
      background: none;
      border: none;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      font-size: inherit;
      padding: 0;
      margin: 0;
    }
    
    .btn-link:hover {
      color: #60a5fa;
    }

    /* Snackbar */
    .snackbar {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%) translateY(120%);
      min-width: 240px;
      max-width: min(92vw, 560px);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.08);
      opacity: 0;
      transition: transform .28s ease, opacity .28s ease;
      z-index: 1000;
    }
    .snackbar.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .snackbar.ok  { background: rgba(16,185,129,.12); color: #bbf7d0; border-color: rgba(16,185,129,.35); }
    .snackbar.err { background: rgba(239,68,68,.12); color: #fecaca; border-color: rgba(239,68,68,.35); }



    /* Card de Descarga */
    .download-card {
      /* El espaciado ahora se maneja con gap en el contenedor */
    }
    .download-card h2 {
      font-size: 1.1rem;
      margin: 0 0 8px;
      color: var(--txt);
    }
    .download-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .download-btn {
      background: linear-gradient(135deg, var(--ok), #059669);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(16,185,129,.3);
    }
    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16,185,129,.4);
    }
    .download-btn:active {
      transform: translateY(0);
    }
    .download-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .download-icon {
      font-size: 1.2rem;
    }
    .download-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .download-info small {
      color: var(--muted);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="cards-container">
    <form class="card" id="movForm" novalidate>
      <h1>Registrar movimiento</h1>
      <p class="sub">Se enviar√° un JSON por POST al webhook de n8n.</p>

      <!-- Tipo -->
      <div class="field" id="f-tipo">
        <label for="tipo">Tipo</label>
        <select name="tipo" id="tipo" required>
          <option value="">Selecciona‚Ä¶</option>
          <option value="ENTRADA">ENTRADA</option>
          <option value="SALIDA">SALIDA</option>
        </select>
        <small class="error">Selecciona ENTRADA o SALIDA.</small>
      </div>

      <!-- Fecha con selector nativo (yyyy-mm-dd) -->
      <div class="field" id="f-fecha">
        <label for="fecha">Fecha</label>
        <div class="input-group">
          <input id="fecha" name="fecha" type="date" required />
          <button type="button" id="btnFechaActual" class="btn-now" title="Usar fecha actual">
            <span>üìÖ</span>
          </button>
        </div>
        <small class="hint">Usa el calendario para elegir la fecha.</small>
        <small class="error">Selecciona una fecha v√°lida.</small>
      </div>

      <!-- Hora con selector nativo (HH:MM 24h) -->
      <div class="field" id="f-hora">
        <label for="hora">Hora</label>
        <div class="input-group">
          <input id="hora" name="hora" type="time" required step="60" />
          <button type="button" id="btnHoraActual" class="btn-now" title="Usar hora actual">
            <span>üïê</span>
          </button>
        </div>
        <small class="hint">Formato 24h: HH:MM.</small>
        <small class="error">Selecciona una hora v√°lida.</small>
      </div>

      <!-- Bot√≥n para autocompletar todo -->
      <div class="field">
        <button type="button" id="btnAutocompletar" class="btn-autocomplete">
          <span>‚ö°</span> Autocompletar fecha y hora actual
        </button>
      </div>

      <button type="submit" id="btnSubmit">Enviar</button>
    </form>

    <!-- Card de Descarga -->
    <div class="card download-card">
      <h2>üìä Descargar Reporte</h2>
      <p class="sub">Descarga el archivo Excel con todos los registros de asistencia.</p>
      
      <div class="download-options">
        <button type="button" id="downloadBtn" class="download-btn">
          <span class="download-icon">üì•</span>
          Descargar Excel
        </button>
        
        <div class="download-info">
          <small>üìã Formato: Excel (.xlsx)</small>
          <small>üîÑ Se actualiza autom√°ticamente</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>



  <script>
    // Usar configuraci√≥n global
    const WEBHOOK_URL = window.APP_CONFIG ? window.APP_CONFIG.WEBHOOK_URL : "https://n8n.ludwringliccien.dev/webhook/asistencias";
    const BASE_PATH = window.APP_CONFIG ? window.APP_CONFIG.BASE_PATH : '';

    // Helpers UI y validaci√≥n
    const form = document.getElementById('movForm');
    const btn = document.getElementById('btnSubmit');
    const snackbar = document.getElementById('snackbar');
    const fieldWrap = (id) => document.getElementById(id);

    function setValidity(fieldId, valid) {
      const wrap = fieldWrap(fieldId);
      if (!wrap) return;
      wrap.classList.toggle('invalid', !valid);
    }
    function showSnack(type, msg, ms = 3500) {
      snackbar.textContent = msg;
      snackbar.className = `snackbar ${type}`;
      requestAnimationFrame(() => snackbar.classList.add('show'));
      clearTimeout(showSnack._t);
      showSnack._t = setTimeout(() => snackbar.classList.remove('show'), ms);
    }

    // Conversi√≥n: de ISO (yyyy-mm-dd) a dd/mm/aaaa
    function isoToDDMMYYYY(iso) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }

    // Validaci√≥n b√°sica de hora HH:MM
    function isValidHHMM(hhmm) {
      return /^\d{2}:\d{2}$/.test(hhmm);
    }

    // ===== FUNCIONES DE AUTOCOMPLETADO =====
    
    // Obtener fecha actual en formato ISO (yyyy-mm-dd)
    function getFechaActual() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // Obtener hora actual en formato HH:MM
    function getHoraActual() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }
    
    // Autocompletar fecha actual
    function autocompletarFecha() {
      const fechaInput = document.getElementById('fecha');
      const fechaActual = getFechaActual();
      fechaInput.value = fechaActual;
      
      // Limpiar validaci√≥n
      setValidity('f-fecha', true);
      
      // Mostrar feedback
      showSnack('ok', `Fecha actual: ${isoToDDMMYYYY(fechaActual)}`);
    }
    
    // Autocompletar hora actual
    function autocompletarHora() {
      const horaInput = document.getElementById('hora');
      const horaActual = getHoraActual();
      horaInput.value = horaActual;
      
      // Limpiar validaci√≥n
      setValidity('f-hora', true);
      
      // Mostrar feedback
      showSnack('ok', `Hora actual: ${horaActual}`);
    }
    
    // Autocompletar fecha y hora actual
    function autocompletarTodo() {
      const btnAutocompletar = document.getElementById('btnAutocompletar');
      
      // Estado de carga
      btnAutocompletar.classList.add('loading');
      btnAutocompletar.innerHTML = '<span>‚è≥</span> Autocompletando...';
      
      // Simular peque√±a pausa para feedback visual
      setTimeout(() => {
        autocompletarFecha();
        autocompletarHora();
        
        // Restaurar bot√≥n
        btnAutocompletar.classList.remove('loading');
        btnAutocompletar.innerHTML = '<span>‚ö°</span> Autocompletar fecha y hora actual';
        
        // Mostrar mensaje final
        showSnack('ok', 'Fecha y hora actuales autocompletadas');
      }, 300);
    }

    // --- Pruebas r√°pidas en consola ("test cases") ---
    try {
      console.assert(isoToDDMMYYYY('2025-08-31') === '31/08/2025', 'isoToDDMMYYYY debe convertir correctamente');
      console.assert(isValidHHMM('09:05') === true, 'isValidHHMM debe aceptar 09:05');
      console.assert(isValidHHMM('23:59') === true, 'isValidHHMM debe aceptar 23:59');
      console.assert(isValidHHMM('9:5') === false, 'isValidHHMM debe rechazar 9:5');
    } catch (_) { /* ignorar en producci√≥n */ }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const tipoOk = form.tipo.value === 'ENTRADA' || form.tipo.value === 'SALIDA';
      setValidity('f-tipo', tipoOk);

      const fechaISO = form.fecha.value; // yyyy-mm-dd
      const fechaOk = /^\d{4}-\d{2}-\d{2}$/.test(fechaISO);
      setValidity('f-fecha', fechaOk);

      const horaVal = form.hora.value; // HH:MM
      const horaOk = isValidHHMM(horaVal);
      setValidity('f-hora', horaOk);

      if (!tipoOk || !fechaOk || !horaOk) {
        // Validaci√≥n local: no llamar al webhook
        return;
      }

      // Payload JSON: env√≠a la fecha en dd/mm/aaaa + ISO opcional
      const payload = {
        tipo: form.tipo.value,
        fecha: isoToDDMMYYYY(fechaISO), // requerido en dd/mm/aaaa
        fecha_iso: fechaISO,             // opcional para tu backend
        hora: horaVal                    // HH:MM (24h)
      };

      // UI: loading
      form.classList.add('loading');
      btn.disabled = true;

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*'
          },
          body: JSON.stringify(payload)
        });

        let responseText = '';
        const contentType = res.headers.get('content-type') || '';
        
        try {
          if (contentType.includes('application/json')) {
            const data = await res.json();
            responseText = JSON.stringify(data);
          } else {
            responseText = await res.text();
          }
        } catch (parseError) {
          // Si falla el parsing JSON, intentar como texto
          console.warn('Error parsing response as JSON, trying as text:', parseError);
          try {
            responseText = await res.text();
          } catch (textError) {
            console.warn('Error reading response as text:', textError);
            responseText = '';
          }
        }

        if (!res.ok) {
          showSnack('err', 'ERROR INTENTELO DE NUEVO');
        } else {
          showSnack('ok', `${form.tipo.value} guardada`);
          form.reset();
        }
      } catch (err) {
        console.error('Error de red o CORS:', err);
        showSnack('err', 'ERROR INTENTELO DE NUEVO');
      } finally {
        form.classList.remove('loading');
        btn.disabled = false;
      }
    });

    // ===== EVENT LISTENERS PARA AUTOCOMPLETADO =====
    
    // Bot√≥n de fecha actual
    document.getElementById('btnFechaActual').addEventListener('click', autocompletarFecha);
    
    // Bot√≥n de hora actual
    document.getElementById('btnHoraActual').addEventListener('click', autocompletarHora);
    
    // Bot√≥n de autocompletar todo
    document.getElementById('btnAutocompletar').addEventListener('click', autocompletarTodo);

    // ===== AUTOCOMPLETADO AUTOM√ÅTICO AL CARGAR =====
    
    // Autocompletar autom√°ticamente al cargar la p√°gina
    window.addEventListener('load', () => {
      setTimeout(autocompletarTodo, 500);
    });

    // ===== PWA FUNCTIONALITY =====
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const swPath = BASE_PATH + '/sw.js';
          const registration = await navigator.serviceWorker.register(swPath);
          console.log('Service Worker registrado:', registration);
          
          // Manejar actualizaciones del Service Worker
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showSnack('ok', 'Nueva versi√≥n disponible. Recarga para actualizar.');
              }
            });
          });
        } catch (error) {
          console.error('Error registrando Service Worker:', error);
        }
      });
    }



    // Detectar estado de conexi√≥n
    function updateOnlineStatus() {
      if (navigator.onLine) {
        document.body.classList.remove('offline');
        showSnack('ok', 'Conexi√≥n restaurada');
      } else {
        document.body.classList.add('offline');
        showSnack('err', 'Sin conexi√≥n - Modo offline activado');
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // Verificar estado inicial
    updateOnlineStatus();

    // Background Sync (si est√° disponible)
    if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
      navigator.serviceWorker.ready.then(registration => {
        // Registrar para sincronizaci√≥n en segundo plano
        registration.sync.register('background-sync');
      });
    }



    // ===== FUNCIONALIDAD DE DESCARGA =====
    
    const downloadBtn = document.getElementById('downloadBtn');
    const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/1ZI_abWmCGMjLH3G_PSE-AvKl98eQcr1Q-DqvCKV1Ff0/export?format=xlsx";
    
    downloadBtn.addEventListener('click', async () => {
      // Estado de carga
      downloadBtn.classList.add('loading');
      downloadBtn.innerHTML = '<span class="download-icon">‚è≥</span>Descargando...';
      
      try {
        // Crear un enlace temporal para la descarga
        const link = document.createElement('a');
        link.href = GOOGLE_SHEETS_URL;
        link.download = `asistencia_${new Date().toISOString().split('T')[0]}.xlsx`;
        link.target = '_blank';
        
        // Agregar el enlace al DOM temporalmente
        document.body.appendChild(link);
        
        // Simular clic para iniciar la descarga
        link.click();
        
        // Remover el enlace temporal
        document.body.removeChild(link);
        
        // Mostrar mensaje de √©xito
        showSnack('ok', 'Descarga iniciada');
        
        // Log para debugging
        console.log('Descarga iniciada:', GOOGLE_SHEETS_URL);
        
      } catch (error) {
        console.error('Error al descargar:', error);
        showSnack('err', 'Error al descargar el archivo');
      } finally {
        // Restaurar estado del bot√≥n
        downloadBtn.classList.remove('loading');
        downloadBtn.innerHTML = '<span class="download-icon">üì•</span>Descargar Excel';
      }
    });

    // Funci√≥n alternativa para descarga directa (si la anterior no funciona)
    async function downloadFile() {
      try {
        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `asistencia_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showSnack('ok', 'Archivo descargado exitosamente');
      } catch (error) {
        console.error('Error en descarga alternativa:', error);
        showSnack('err', 'Error al descargar. Verifica la URL del documento.');
      }
    }
  </script>
</body>
</html>
